"use strict";(self.webpackChunkafterlogic_aurora_platform=self.webpackChunkafterlogic_aurora_platform||[]).push([[7350],{"8znj":(e,i,t)=>{e.exports=function(e){const i=t("H20a"),o=t("9kOp");return t("TdEd").isModuleEnabled("FilesWebclient")&&o.isUserNormalOrTenant()?{start:function(e){o.subscribeEvent("MailWebclient::AddAllAttachmentsDownloadMethod",(e=>{e({Text:i.i18n("MAILSAVEATTACHMENTSTOFILESPLUGIN/ACTION_SAVE_ATTACHMENTS_TO_FILES"),Handler:function(e,i,o){const s=t("oUN1"),l=t("Mmce");s.showPopup(l,[o,e])}})}))}}:null}},Mmce:(e,i,t)=>{var o=t("M4cL");const s=t("a7T2"),l=t("p09A"),n=t("H20a"),a=t("REt5"),r=t("EFhx"),h=t("/QeJ"),p=t("9kOp"),d=t("o1lX"),c=t("qBBW"),u=t("TdEd"),f=t("oUN1"),F=t("skxT"),m=t("OfVV"),w=t("hkZk"),g=u.run("CoreParanoidEncryptionWebclientPlugin","isEnabled");function S(){d.call(this),this.filesView=new w(!0,!1),this.filesView.onSelectClickPopupBound=()=>{},this.filesView.onCreateFolderResponse=function(e,i){if(e.Result){const e=`${i.Parameters.Path}/${i.Parameters.FolderName}`,t=i.Parameters.Type;this.routeFiles(t,e,"",!0)}else h.showErrorByCode(e),this.routeFiles(this.storageType(),this.currentPath(),this.searchPattern(),!0)}.bind(this.filesView),this.isSaving=l.observable(!1),this.isSaving.subscribe((function(){this.filesView.disableRoute=this.isSaving()}),this),this.allowCreateFolder=l.computed((function(){return!this.isSaving()}),this),this.createFolderCommand=a.createCommand(this,this.createFolder,this.allowCreateFolder),this.allowSelectFolder=l.computed((function(){return!this.isSaving()&&("shared"!==this.filesView.storageType()||""!==this.filesView.currentPath())}),this),this.selectFolderCommand=a.createCommand(this,this.selectFolder,this.allowSelectFolder)}s.extendOwn(S.prototype,d.prototype),S.prototype.PopupTemplate="MailSaveAttachmentsToFilesPlugin_SelectFilesPopup",S.prototype.onOpen=function(e,i){this.initUploader(),this.attachmentsData=e.map((e=>({attach:e,FileName:e.fileName(),Size:e.size(),Hash:e.hash(),Type:e.mimeType()}))),this.accountId=i,this.filesView.onShow(),this.filesView.routeFiles("personal","")},S.prototype.onBind=function(){this.filesView.onBind(this.$popupDom)},S.prototype.hideLoading=function(){this.isSaving(!1),F.hideLoading()},S.prototype.onClose=function(){this.hideLoading()},S.prototype.selectFolder=function(){const e=this.attachmentsData.filter((e=>this.filesView.isFileCanBeUploaded(e)));if(e.length>0){const i=[this.filesView.storageType(),this.filesView.currentPath(),this.accountId,e],t=()=>{this.encryptAndSaveToFolder(e)},o=()=>{this.saveToFolder(...i)},s=()=>{this.closePopup()};if(g){const i=u.run("CoreParanoidEncryptionWebclientPlugin","getConfirmEncryptionPopup");"encrypted"===this.filesView.storageType()?t():"personal"===this.filesView.storageType()&&i?f.showPopup(i,[t,o,s,e.length,e.map((e=>e.FileName))]):o()}else o()}},S.prototype.saveToFolder=function(e,i,t,o){o.forEach((e=>{this.filesView.onFileUploadSelect(e.Hash,e),this.filesView.onFileUploadStart(e.Hash),this.filesView.onFileUploadProgress(e.Hash,.2*e.Size,e.Size)}));const s={AccountID:t,Attachments:o.map((e=>e.Hash)),Storage:e,Path:i};F.showLoading(n.i18n("COREWEBCLIENT/INFO_LOADING")),this.isSaving(!0),r.send("MailSaveAttachmentsToFilesPlugin","Save",s,(e=>{this.hideLoading(),e.Result?(this.attachmentsData.forEach((e=>{this.filesView.onFileUploadComplete(e.Hash,!0,{Result:!0})})),this.onFileUploadComplete()):h.showErrorByCode(e)}))},S.prototype.onFileUploadComplete=function(){if(this.filesView.uploadingFiles().length>0)return;const e=u.run("FilesWebclient","getHeaderItem");e&&e.item&&e.item.recivedAnim(!0);const i=this.attachmentsData.length,t=n.i18n("MAILSAVEATTACHMENTSTOFILESPLUGIN/REPORT_FILES_SAVED_SUCCESSFULLY_PLURAL",null,null,i);F.showReport(t),setTimeout((()=>{this.closePopup()}),1e3),this.hideLoading()},S.prototype.encryptAndSaveToFolder=function(e){e.forEach((e=>{this.filesView.onFileUploadSelect(e.Hash,e),this.filesView.onFileUploadStart(e.Hash),this.filesView.onFileUploadProgress(e.Hash,.1*e.Size,e.Size)})),F.showLoading(n.i18n("COREWEBCLIENT/INFO_LOADING")),this.isSaving(!0),e.map((e=>e.attach)).forEach((e=>{const i=e.getActionUrl("download");o.ajax({url:i,cache:!1,xhrFields:{responseType:"blob"},success:i=>{this.encryptBlob(e,i)},error:function(i){this.hideLoading(),this.filesView.onFileUploadComplete(e.hash(),!1,{Result:!1})}})}))},S.prototype.encryptBlob=function(e,i){this.oJua.addFile(e.hash(),{File:i,FileName:e.fileName(),Folder:"",Size:i.size,Type:i.type,EncryptWithoutConfirm:!0});const t=this.filesView.getUploadFileByUid(e.hash());t&&this.filesView.onFileUploadProgress(e.hash(),.2*t.size(),t.size())},S.prototype.initUploader=function(){this.oJua||(this.oJua=new c({action:"?/Api/",name:"jua-uploader",queueSize:2,clickElement:null,hiddenElementsPosition:m.IsRTL?"right":"left",dragAndDropElement:null,disableAjaxUpload:!1,disableFolderDragAndDrop:!0,disableDragAndDrop:!0,hidden:s.extendOwn({Module:"Files",Method:"UploadFile",Parameters:e=>JSON.stringify({Type:this.filesView.storageType(),SubPath:"",Path:this.filesView.currentPath(),Overwrite:!1})},p.getCommonRequestParameters())}),this.oJua.on("onProgress",((e,i,t)=>{let o=i/t;o<.2&&(o=.2),this.filesView.onFileUploadProgress(e,t*o,t)})).on("onSelect",this.filesView.onFileUploadSelect.bind(this.filesView)).on("onStart",(e=>{this.filesView.onFileUploadStart(e);const i=this.filesView.getUploadFileByUid(e);i&&this.filesView.onFileUploadProgress(e,.2*i.size(),i.size())})).on("onComplete",((e,i,t)=>{this.filesView.onFileUploadComplete(e,i,t),this.onFileUploadComplete()})).on("onCancel",(e=>{this.filesView.onCancelUpload(e),0===this.filesView.uploadingFiles().length&&this.hideLoading()})))},S.prototype.createFolder=function(){this.filesView.executeCreateFolder()},e.exports=new S}}]);